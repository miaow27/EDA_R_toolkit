---
title: "EDA_R_toolkit"
author: "Miao Wang"
date: "9/18/2018"
output:
  html_document:
---
# Toy Data
```{r, include=F}
library(dplyr)
library(tidyverse)
str(storms)
```

# 1. Use `here` for setting relative-path in Rproj

We want to create a R project and always use a relative-path for the file. It is easier for version-control (If data file change location).
```{r, eval=F}
library(magrittr)
library(dplyr)
library(tidyverse)
library(zipcode)

dt1 <- readxl::read_xlsx(
  here::here("data", "001-vendor-data-sample", "01", "cln",
             "d001-vendor-data-sample-20180914.xlsx"),
  na = c("","NULL")
) %>%
  janitor::clean_names()
```

# 2. Check Missing
Missing might be in many forms, check unique values of the data field before using. 
```{r}
check_missing <- function(.data, .field) {
  # Does not work on NA sets
  if(sum(is.na(.data[,.field]))>0){
    
    print("Already have NA")
    retunr(0)
  }
  
  .field <- sym(.field)
  .data %>% 
    mutate(miss_n = 
             (!!.field == "(Unknown)") %>% as.numeric() +
             (!!.field  == "NULL") %>% as.numeric() +
             (is.na(!!.field )) %>% as.numeric() +
             is.null(!!.field ) %>% as.numeric() +
             (!!.field  == "") %>% as.numeric() + 
             (!!.field  == 'Unknown') %>% as.numeric()) %>% 
    summarise(miss_tot = sum(miss_n),
              miss_porp = mean(miss_n))

}
```

## Example 
```{r}
# check if there is any NA
colSums(is.na(storms))

# Only apply on NA sets
sub_var <- colnames(storms)[colSums(is.na(storms))==0]
sub_var %>% 
  set_names(sub_var) %>% 
  map_dfr(.x=.,.f=check_missing,
          .data = storms,
          .id="variable")
```

# 3. Confirmn 1-1 Relationship
Imagine the data is at transaction level. But we also have bank-level information. We should be careful running the summary on bank-level info and avoid double count. 

This is a code to identify and check whether the given variable is a high-level information. (Do you have multiple possible value for the same unique bank? If so, then that variable might not be bank-level info)

This is very-useful to pre-check the data before building a hirachical data model. 

```{r}
# check if the field has unique value for a unique id_var
## only include the field and the identifier field
check_unique_within_id = function(.data,.X,.id){
    f1 <- sym(.X) # convert to symbol
    f2 <- sym(.id)
    
    .data %>% 
        count(!!f1,!!f2) %>% 
        count(!!f2) %>% 
        mutate(non_unique = (nn!=1)) %>% 
        summarise(One_to_one = sum(non_unique)==0, 
                  Prop_one_to_many = mean(non_unique))
}
```

## Examples
```{r}
colnames(storms)[1]
range_colnames <- colnames(storms)[-1]
range_colnames %>% map(.f=check_unique_within_id,
                      .data = storms,
                      .id = colnames(storms)[1]) %>% 
  set_names(range_colnames) %>% 
  bind_rows(.id = "Variable")
```

# 4. Plot hist with sorted y axis
```{r}
plot_top_all <- function(.data,.field,plot_str){
  f <- sym(.field) # turn str to symbol
  
  df <- .data %>% 
    count(!!f)  %>% 
    set_names(c("X","n"))
  
  df$new_X = factor(df$X, levels = df$X[order(df$n)])
  
  df %>% 
    ggplot(aes(new_X,n))+
    geom_col()+
    ggtitle(plot_str) +
    coord_flip() + 
    xlab(.field)
}
```

## Example 
```{r}
plot_top_all(storms,"wind","Wind Hist")
```


# 5. Plot top n level of a Categorical Variable/(Sprase Continous)
Include (NA) count at bottom 
```{r}
plot_top_n <- function(.data,.field,n_top_val){
  f <- sym(.field) # turn str to symbol
  
  df <- .data %>% 
    count(!!f)  %>% 
    set_names(c("X","n")) %>% 
    top_n(n_top_val)
  
  if(sum(is.na(.data[,.field]))!=0){
    df <- rbind(df, c("NA",sum(is.na(.data[,.field]))))
  }
  
  df$new_X = factor(df$X, levels = df$X[order(df$n)])
  
  df %>% 
    ggplot(aes(new_X,n))+
    geom_col()+
    ggtitle(paste0("Top ",n_top_val," Levels")) +
    coord_flip() + 
    xlab(.field)
}
```

# Example
```{r}
plot_top_n(storms,"wind",20)
```





